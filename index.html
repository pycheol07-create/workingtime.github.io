<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>물류팀 업무현황</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        .chart {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
        }
        .chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background-color: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .toast {
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.3s ease-out;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            line-height: 1;
            color: #9ca3af;
            cursor: pointer;
            background: none;
            border: none;
        }
        .modal-close-btn:hover {
            color: #1f2937;
        }
        .dashboard-card {
            background-color: #1f2937; /* bg-gray-800 */
        }
        .dashboard-card p {
            font-size: 2rem;
            line-height: 2.5rem;
            font-weight: 700;
            color: #7dd3fc; /* text-sky-300 */
            text-shadow: 0 0 5px rgba(125, 211, 252, 0.5);
        }
        .dashboard-card h4 {
            color: #9ca3af; /* text-gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center p-4">
    <!-- 알림 메시지 (Toast) -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-2 w-full max-w-xs"></div>

    <div class="w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-gray-200 relative">
        
        <!-- 날짜 표시 -->
        <div id="current-date-display" class="absolute top-4 left-6 text-lg font-bold text-gray-700"></div>

        <div class="absolute top-4 right-6 flex flex-col items-end gap-2">
            <!-- 연결 상태 표시기 -->
            <div id="connection-indicator" class="flex items-center gap-2">
                <span id="status-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400"></span>
                <span id="connection-status" class="text-xs font-medium text-gray-500"></span>
            </div>
            <!-- 전체 초기화 버튼 -->
            <button id="reset-app-btn" class="flex items-center gap-1 text-xs text-gray-500 hover:text-red-600 font-semibold transition p-1 rounded hover:bg-red-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 10.5M20 20l-1.5-1.5A9 9 0 003.5 13.5" />
                </svg>
                <span>초기화</span>
            </button>
        </div>
        
        <!-- 헤더 -->
        <header class="mb-8 pt-4 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">물류팀 업무현황</h1>
        </header>

        <!-- 요약 정보 대시보드 -->
        <div class="mb-8 bg-gray-800 text-white rounded-lg border border-gray-700 shadow-lg">
            <div id="toggle-summary" class="flex justify-between items-center p-4 cursor-pointer md:cursor-auto">
                <h2 class="text-xl font-bold">실시간 현황판</h2>
                <svg id="summary-arrow" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:hidden transition-transform transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div id="summary-content" class="hidden md:grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4 p-6 text-center">
                <div class="dashboard-card p-4 rounded-lg">
                    <h4 class="text-sm font-bold uppercase tracking-wider">총원</h4>
                    <p id="summary-total-staff">0</p>
                </div>
                 <div class="dashboard-card p-4 rounded-lg">
                    <h4 class="text-sm font-bold uppercase tracking-wider">휴무</h4>
                    <p id="summary-leave-staff">0</p>
                </div>
                 <div class="dashboard-card p-4 rounded-lg">
                    <h4 class="text-sm font-bold uppercase tracking-wider">근무</h4>
                    <p id="summary-active-staff">0</p>
                </div>
                 <div class="dashboard-card p-4 rounded-lg">
                    <h4 class="text-sm font-bold uppercase tracking-wider">업무중</h4>
                    <p id="summary-working-staff">0</p>
                </div>
                 <div class="dashboard-card p-4 rounded-lg">
                    <h4 class="text-sm font-bold uppercase tracking-wider">대기</h4>
                    <p id="summary-idle-staff">0</p>
                </div>
                 <div class="dashboard-card p-4 rounded-lg">
                    <h4 class="text-sm font-bold uppercase tracking-wider">진행업무</h4>
                    <p id="summary-ongoing-tasks">0</p>
                </div>
                 <div class="dashboard-card p-4 rounded-lg">
                    <h4 class="text-sm font-bold uppercase tracking-wider">업무진행시간</h4>
                    <p id="summary-total-work-time">0</p>
                </div>
            </div>
        </div>


        <!-- 실시간 팀 현황 보드 -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-4">실시간 팀 현황</h2>
            <div id="team-status-board" class="space-y-8">
                <!-- Real-time status content will be dynamically inserted here -->
            </div>
        </div>

        <!-- 업무 시작 폼 -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
             <h2 class="text-xl font-bold text-gray-900 mb-4">업무 시작 (팀원 현황에서 인원 선택)</h2>
            <form id="work-start-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">업무 종류</label>
                    <button type="button" id="open-task-modal-btn" class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-2.5 text-left focus:ring-blue-500 focus:border-blue-500 transition">업무를 선택하세요</button>
                </div>
                 <div class="md:col-span-1">
                    <label for="part-timer-count" class="block text-sm font-medium text-gray-700 mb-2">알바 추가</label>
                    <select id="part-timer-count" class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500 transition">
                    </select>
                </div>
                <div class="md:col-span-1">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">
                        업무 시작
                    </button>
                </div>
            </form>
        </div>

        <!-- 완료된 업무 기록 테이블 -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <div id="toggle-completed-log" class="flex justify-between items-center cursor-pointer md:cursor-auto">
                <h2 class="text-xl font-bold text-gray-900">오늘 완료된 업무</h2>
                <svg id="completed-log-arrow" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:hidden transition-transform transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div id="completed-log-content" class="hidden md:block mt-4">
                <div class="flex flex-wrap gap-2 justify-end items-center mb-4">
                    <button id="open-history-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md">이력 보기</button>
                    <button id="save-progress-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md">중간 저장</button>
                    <button id="end-shift-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md">업무 마감</button>
                </div>
                <div class="overflow-auto max-h-[40vh] relative bg-white rounded-md">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-blue-500 uppercase bg-gray-100 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-6 py-3">이름</th>
                                <th scope="col" class="px-6 py-3">업무</th>
                                <th scope="col" class="px-6 py-3">시작 시간</th>
                                <th scope="col" class="px-6 py-3">종료 시간</th>
                                <th scope="col" class="px-6 py-3">소요 시간</th>
                                <th scope="col" class="px-6 py-3 text-right">
                                    <button id="delete-all-completed-btn" class="text-xs font-bold text-red-500 uppercase hover:text-red-700">일괄삭제</button>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="work-log-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 오늘의 업무 비중 분석 -->
        <div class="p-6 bg-gray-50 rounded-lg border border-gray-200">
            <div id="toggle-analysis" class="flex justify-between items-center cursor-pointer md:cursor-auto">
                <h2 class="text-xl font-bold text-gray-900">오늘의 업무 비중 분석</h2>
                 <svg id="analysis-arrow" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:hidden transition-transform transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            <div id="analysis-content" class="hidden md:block mt-4">
                <!-- Chart will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="stop-individual-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative">
            <button class="modal-close-btn">&times;</button>
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 text-yellow-400 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
                <h3 id="stop-individual-confirm-message" class="mb-5 text-lg font-normal text-gray-700"></h3>
                <button type="button" id="confirm-stop-individual-btn" class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">예, 종료합니다</button>
                <button type="button" id="cancel-stop-individual-btn" class="text-gray-700 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">아니요, 취소합니다</button>
            </div>
        </div>
    </div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative"><button class="modal-close-btn">&times;</button><div class="p-6 text-center"><svg class="mx-auto mb-4 text-gray-400 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg><h3 id="delete-confirm-message" class="mb-5 text-lg font-normal text-gray-700"></h3><p class="mb-6 text-sm text-gray-500">이 작업은 되돌릴 수 없습니다.</p><button type="button" id="confirm-delete-btn" class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">예, 삭제합니다</button><button type="button" id="cancel-delete-btn" class="text-gray-700 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">아니요, 취소합니다</button></div></div>
    </div>
    <div id="reset-app-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative"><button class="modal-close-btn">&times;</button>
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 text-yellow-400 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
                <h3 class="mb-5 text-lg font-normal text-gray-700">오늘의 모든 현황을 초기화하시겠습니까?</h3>
                <p class="mb-6 text-sm text-gray-500">진행중인 업무와 완료된 업무 기록이 모두 삭제됩니다. 이 작업은 되돌릴 수 없습니다.</p>
                <button type="button" id="confirm-reset-app-btn" class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">예, 초기화합니다</button>
                <button type="button" id="cancel-reset-app-btn" class="text-gray-700 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">아니요, 취소합니다</button>
            </div>
        </div>
    </div>
    <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center"><h2 class="text-xl font-bold text-gray-900">업무 이력 보기</h2><button id="close-history-btn" class="modal-close-btn">&times;</button></div>
            <div class="flex-grow flex overflow-hidden">
                <div id="history-date-list-container" class="w-1/4 border-r border-gray-200 overflow-y-auto bg-gray-50"><ul id="history-date-list" class="p-2"></ul></div>
                <div class="w-3/4 flex flex-col">
                    <div class="p-4 border-b border-gray-200">
                        <div id="history-tabs" class="flex gap-4">
                            <button data-view="daily" class="history-tab-btn pb-2">일별 상세</button>
                            <button data-view="weekly" class="history-tab-btn pb-2">주별 요약</button>
                            <button data-view="monthly" class="history-tab-btn pb-2">월별 요약</button>
                        </div>
                    </div>
                    <div id="history-view-container" class="flex-grow p-6 overflow-y-auto bg-gray-50">
                        <div id="history-daily-view" class="hidden"></div>
                        <div id="history-weekly-view" class="hidden space-y-6"></div>
                        <div id="history-monthly-view" class="hidden space-y-6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="quantity-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative">
            <div class="p-6 border-b border-gray-200"><h2 id="quantity-modal-title" class="text-xl font-bold text-gray-900">업무별 처리량 입력</h2><button class="modal-close-btn">&times;</button></div>
            <div id="modal-task-quantity-inputs" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 max-h-[60vh] overflow-y-auto">
                <!-- Inputs will be generated here by JS -->
            </div>
            <div class="p-4 bg-gray-50 rounded-b-2xl flex justify-end gap-4">
                <button type="button" id="cancel-quantity-btn" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition">취소</button>
                <button type="button" id="confirm-quantity-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">확인 및 저장</button>
            </div>
        </div>
    </div>
     <div id="quantity-on-stop-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative">
            <div class="p-6 border-b border-gray-200"><h2 class="text-xl font-bold text-gray-900">처리량 입력</h2><button class="modal-close-btn">&times;</button></div>
            <div class="p-6 space-y-4">
                <p>업무 <span id="quantity-on-stop-task-name" class="font-bold"></span>의 처리량을 입력하세요.</p>
                <div>
                    <label for="quantity-on-stop-input" class="block text-sm font-medium text-gray-700">처리량 (개)</label>
                    <input type="number" id="quantity-on-stop-input" min="0" class="mt-1 w-full bg-white border border-gray-300 rounded-lg p-2">
                </div>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-2xl flex justify-end gap-4">
                <button type="button" id="cancel-quantity-on-stop" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition">나중에 입력</button>
                <button type="button" id="confirm-quantity-on-stop" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">확인</button>
            </div>
        </div>
    </div>
    <div id="delete-history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative"><button class="modal-close-btn">&times;</button>
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 text-gray-400 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
                <h3 class="mb-5 text-lg font-normal text-gray-700">정말로 이 날짜의 모든 기록을 삭제하시겠습니까?</h3>
                <p class="mb-6 text-sm text-gray-500">이 작업은 되돌릴 수 없습니다.</p>
                <button type="button" id="confirm-history-delete-btn" class="text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">예, 삭제합니다</button>
                <button type="button" id="cancel-history-delete-btn" class="text-gray-700 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">아니요, 취소합니다</button>
            </div>
        </div>
    </div>
    <div id="edit-record-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative">
            <div class="p-6 border-b border-gray-200"><h2 class="text-xl font-bold text-gray-900">업무 기록 수정</h2><button class="modal-close-btn">&times;</button></div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="edit-member-name" class="block text-sm font-medium text-gray-700">이름</label>
                    <input type="text" id="edit-member-name" class="mt-1 w-full bg-gray-50 border border-gray-300 rounded-lg p-2" readonly>
                </div>
                 <div>
                    <label for="edit-task-type" class="block text-sm font-medium text-gray-700">업무</label>
                    <select id="edit-task-type" class="mt-1 w-full bg-white border border-gray-300 rounded-lg p-2"></select>
                </div>
                 <div>
                    <label for="edit-start-time" class="block text-sm font-medium text-gray-700">시작 시간 (HH:MM)</label>
                    <input type="time" id="edit-start-time" class="mt-1 w-full bg-white border border-gray-300 rounded-lg p-2">
                </div>
                 <div>
                    <label for="edit-end-time" class="block text-sm font-medium text-gray-700">종료 시간 (HH:MM)</label>
                    <input type="time" id="edit-end-time" class="mt-1 w-full bg-white border border-gray-300 rounded-lg p-2">
                </div>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-2xl flex justify-end gap-4">
                <button type="button" id="cancel-edit-btn" class="bg-white hover:bg-gray-100 border border-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition">취소</button>
                <button type="button" id="confirm-edit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">저장</button>
            </div>
        </div>
    </div>

     <!-- Task Selection Modal -->
    <div id="task-select-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl relative">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">업무 종류 선택</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div id="task-modal-content" class="p-6 max-h-[70vh] overflow-y-auto flex flex-col md:flex-row gap-6">
                <!-- Task groups will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // ===================================================================================
        // Firebase project configuration
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxmX7fEISWYs_JGktAZrFjdb8cb_ZcmSY",
            authDomain: "work-tool-e2943.firebaseapp.com",
            projectId: "work-tool-e2943",
            storageBucket: "work-tool-e2943.appspot.com",
            messagingSenderId: "133294945093",
            appId: "1:133294945093:web:cde90aab6716127s512842c",
            measurementId: "G-ZZQLKB0057"
        };

        // --- DOM Elements ---
        const connectionStatusEl = document.getElementById('connection-status');
        const statusDotEl = document.getElementById('status-dot');
        const teamStatusBoard = document.getElementById('team-status-board');
        
        // --- Modal Elements ---
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const historyModal = document.getElementById('history-modal');
        const openHistoryBtn = document.getElementById('open-history-btn');
        const closeHistoryBtn = document.getElementById('close-history-btn');
        const historyDateList = document.getElementById('history-date-list');
        const historyViewContainer = document.getElementById('history-view-container');
        const historyTabs = document.getElementById('history-tabs');
        const quantityModal = document.getElementById('quantity-modal');
        const confirmQuantityBtn = document.getElementById('confirm-quantity-btn');
        const cancelQuantityBtn = document.getElementById('cancel-quantity-btn');
        const deleteHistoryModal = document.getElementById('delete-history-modal');
        const confirmHistoryDeleteBtn = document.getElementById('confirm-history-delete-btn');
        const cancelHistoryDeleteBtn = document.getElementById('cancel-history-delete-btn');
        const deleteAllCompletedBtn = document.getElementById('delete-all-completed-btn');
        const editRecordModal = document.getElementById('edit-record-modal');
        const confirmEditBtn = document.getElementById('confirm-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveProgressBtn = document.getElementById('save-progress-btn');
        const quantityOnStopModal = document.getElementById('quantity-on-stop-modal');
        const confirmQuantityOnStopBtn = document.getElementById('confirm-quantity-on-stop');
        const cancelQuantityOnStopBtn = document.getElementById('cancel-quantity-on-stop');
        const endShiftBtn = document.getElementById('end-shift-btn');
        const resetAppBtn = document.getElementById('reset-app-btn');
        const resetAppModal = document.getElementById('reset-app-modal');
        const confirmResetAppBtn = document.getElementById('confirm-reset-app-btn');
        const cancelResetAppBtn = document.getElementById('cancel-reset-app-btn');
        const taskSelectModal = document.getElementById('task-select-modal');
        const stopIndividualConfirmModal = document.getElementById('stop-individual-confirm-modal');
        const confirmStopIndividualBtn = document.getElementById('confirm-stop-individual-btn');
        const cancelStopIndividualBtn = document.getElementById('cancel-stop-individual-btn');
        const stopIndividualConfirmMessage = document.getElementById('stop-individual-confirm-message');
        
        // --- Toggles ---
        const toggleCompletedLog = document.getElementById('toggle-completed-log');
        const completedLogContent = document.getElementById('completed-log-content');
        const completedLogArrow = document.getElementById('completed-log-arrow');
        const toggleAnalysis = document.getElementById('toggle-analysis');
        const analysisContent = document.getElementById('analysis-content');
        const analysisArrow = document.getElementById('analysis-arrow');
        const toggleSummary = document.getElementById('toggle-summary');
        const summaryContent = document.getElementById('summary-content');
        const summaryArrow = document.getElementById('summary-arrow');


        // --- Firebase State ---
        let db, auth;
        let unsubscribeToday;
        const APP_ID = "team-work-logger-v2";

        // --- App State ---
        let appState = {
            workRecords: [],
            taskQuantities: {},
            onLeaveMembers: [],
            selectedForTask: [],
            hiddenGroupIds: []
        };
        let appConfig = { memberWages: {} };
        let selectedTaskForStart = null;
        let recordToDeleteId = null;
        let recordToStopId = null;
        let historyKeyToDelete = null;
        let allHistoryData = [];
        let recordToEditId = null;
        let deleteMode = 'single';
        let elapsedTimeTimer = null;
        let groupToStopId = null;
        let quantityModalContext = { mode: 'today', dateKey: null, onConfirm: null, onCancel: null };


        // --- Config ---
        const teamGroups = [
            { name: '관리', members: ['박영철', '박호진', '유아라', '이승운'] },
            { name: '공통파트', members: ['김수은', '이미숙', '김현', '박상희', '배은정', '김성곤', '김동훈', '신민재', '황호석'] },
            { name: '담당파트', members: ['송다진', '정미혜', '진희주'] },
        ];
         const defaultMemberWages = {
            '유아라': 14114, '박호진': 14354, '송다진': 11722, '정미혜': 11483,
            '김수은': 11253, '이미숙': 11253, '이승운': 14593, '진희주': 10526,
            '김현': 10287, '배은정': 10287, '박상희': 10287, '김동훈': 10287,
            '신민재': 10047, '황호석': 10047
        };
        const taskGroups = {
            '공통': ['국내배송', '중국제작', '직진배송', '티니', '택배포장', '해외배송', '재고조사', '앵글정리', '상품재작업'],
            '담당': ['개인담당업무', '상.하차', '검수', '아이롱', '오류'],
            '기타': ['채우기', '강성', '2층업무', '재고찾는시간']
        };
        const taskTypes = [].concat(...Object.values(taskGroups));
        const quantityTaskTypes = ['채우기', '국내배송', '직진배송', '중국제작', '티니', '택배포장', '해외배송', '상.하차', '검수'];
        
        // --- Utility Functions ---
        const showToast = (message, isError = false) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast p-3 rounded-lg shadow-xl text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.textContent = message;
            container.prepend(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 3000);
        };

        const formatTimeTo24H = (timeStr) => {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const date = new Date(1970, 0, 1, hours, minutes);
            return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        };
        
        const getCurrentTime = () => {
            const now = new Date();
            return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        const formatDuration = (minutes) => {
            minutes = Math.round(minutes);
            if (isNaN(minutes) || minutes < 0) return '0 분';
            if (minutes === 0) return '0 분';
            const h = Math.floor(minutes / 60);
            const m = Math.round(minutes % 60);
            let result = '';
            if (h > 0) result += `${h} 시간 `;
            if (m > 0) result += `${m} 분`;
            return result.trim();
        };

        const isWeekday = (dateString) => {
            const date = new Date(dateString + 'T00:00:00'); // Treat as local date
            const day = date.getDay();
            return day >= 1 && day <= 5; // Monday to Friday
        };

        const formatHours = (minutes) => {
             if (isNaN(minutes) || minutes <= 0) return '0 시간';
             return `${(minutes / 60).toFixed(1)} 시간`;
        }
        
        const getTodayDateString = () => {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localDate = new Date(now - offset);
            return localDate.toISOString().slice(0, 10);
        };

        const getWeekOfYear = (date) => {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        };

        const updateElapsedTimes = () => {
            let totalOngoingMinutes = 0;
            const now = new Date();
            const nowTimeForCalc = new Date(`1970-01-01T${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`);

            const ongoingRecords = (appState.workRecords || []).filter(r => r.status === 'ongoing');

            ongoingRecords.forEach(record => {
                const startTime = new Date(`1970-01-01T${record.startTime}`);
                const elapsedMilliseconds = nowTimeForCalc - startTime;
                const elapsedMinutes = elapsedMilliseconds / (1000 * 60);
                totalOngoingMinutes += elapsedMinutes;
            });

            document.querySelectorAll('.ongoing-duration').forEach(el => {
                const startTimeStr = el.dataset.startTime;
                if (!startTimeStr) return;
                const startTime = new Date(`1970-01-01T${startTimeStr}`);
                const elapsedMilliseconds = nowTimeForCalc - startTime;
                const elapsedMinutes = elapsedMilliseconds / (1000 * 60);
                el.textContent = `(진행: ${formatDuration(elapsedMinutes)})`;
            });

            const completedRecords = (appState.workRecords || []).filter(r => r.status === 'completed');
            const totalCompletedMinutes = completedRecords.reduce((sum, record) => sum + record.duration, 0);

            const liveTotalWorkTime = totalCompletedMinutes + totalOngoingMinutes;
            document.getElementById('summary-total-work-time').textContent = formatDuration(liveTotalWorkTime);
        };


        // --- Render Functions ---
         const renderQuantityModalInputs = (sourceQuantities = {}) => {
            const container = document.getElementById('modal-task-quantity-inputs');
            container.innerHTML = '';
            quantityTaskTypes.forEach(task => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="modal-quantity-${task}" class="block text-sm font-medium text-gray-700">${task}</label>
                    <input type="number" id="modal-quantity-${task}" data-task="${task}" value="${sourceQuantities[task] || 0}" min="0" class="mt-1 w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 transition">
                `;
                container.appendChild(div);
            });
        };

        const renderTaskSelectionModal = () => {
            const container = document.getElementById('task-modal-content');
            container.innerHTML = '';
            Object.entries(taskGroups).forEach(([groupName, tasks]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'flex-1'; // Each group container will take equal space
                let tasksHtml = tasks.map(task => `<button type="button" data-task="${task}" class="task-select-btn w-full text-left p-3 rounded-md hover:bg-blue-100 transition focus:ring-2 focus:ring-blue-300">${task}</button>`).join('');
                groupDiv.innerHTML = `
                    <div class="bg-gray-50 rounded-lg border h-full">
                        <h3 class="text-lg font-bold text-gray-800 mb-0 p-3 border-b bg-gray-100 rounded-t-lg">${groupName}</h3>
                        <div class="p-3 grid grid-cols-1 sm:grid-cols-2 gap-2">${tasksHtml}</div>
                    </div>
                `;
                container.appendChild(groupDiv);
            });
        };

        const renderTaskAnalysis = () => {
            const analysisContainer = document.getElementById('analysis-content');
            analysisContainer.innerHTML = '';
            const completedRecords = appState.workRecords.filter(r => r.status === 'completed');
            const totalLoggedMinutes = completedRecords.reduce((sum, record) => sum + record.duration, 0);

            if (totalLoggedMinutes === 0) {
                analysisContainer.innerHTML = `<div class="text-center text-gray-500 py-4">완료된 업무가 없어 분석을 시작할 수 없습니다.</div>`;
                return;
            }

            const taskColors = {'채우기':'#3b82f6','국내배송':'#10b981','중국제작':'#8b5cf6','직진배송':'#22c55e','티니':'#ef4444','택배포장':'#f97316','해외배송':'#06b6d4','재고조사':'#d946ef','앵글정리':'#eab308','아이롱':'#6366f1','강성':'#ec4899','상.하차':'#6b7280','2층업무':'#78716c','오류':'#f43f5e','재고찾는시간':'#a855f7','검수':'#14b8a6', '개인담당업무': '#1d4ed8', '상품재작업': '#f59e0b'};
            const taskAnalysis = completedRecords.reduce((acc, record) => {
                acc[record.task] = (acc[record.task] || 0) + record.duration;
                return acc;
            }, {});

            const sortedTasks = Object.entries(taskAnalysis).sort(([, a], [, b]) => b - a);

            let gradientParts = [];
            let cumulativePercentage = 0;
            let legendHTML = '<div class="flex-grow">';

            sortedTasks.forEach(([task, minutes]) => {
                const percentage = (minutes / totalLoggedMinutes) * 100;
                const color = taskColors[task] || '#6b7280';
                if (percentage > 0) {
                    gradientParts.push(`${color} ${cumulativePercentage}% ${cumulativePercentage + percentage}%`);
                    cumulativePercentage += percentage;
                }
                legendHTML += `<div class="flex items-center justify-between mb-2"><div class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color};"></span><span class="font-semibold text-gray-700">${task}</span></div><div class="text-right"><div class="text-sm font-semibold text-gray-800">${formatDuration(minutes)}</div><div class="text-xs text-gray-500">${percentage.toFixed(1)}%</div></div></div>`;
            });
            legendHTML += '</div>';

            const finalGradient = `conic-gradient(${gradientParts.join(', ')})`;
            analysisContainer.innerHTML = `<div class="flex flex-col md:flex-row items-center gap-6 md:gap-8"><div class="flex-shrink-0"><div class="chart" style="background: ${finalGradient};"><div class="chart-center"><span class="text-sm text-gray-500">총 업무</span><span class="text-xl font-bold text-blue-600 mt-1">${formatDuration(totalLoggedMinutes)}</span></div></div></div>${legendHTML}</div>`;
        };

        const render = () => {
            renderRealtimeStatus();
            renderCompletedWorkLog();
            updateSummary();
            renderTaskAnalysis();
        };

        const renderRealtimeStatus = () => {
            teamStatusBoard.innerHTML = '';

            const memberGroupMap = new Map();
            teamGroups.forEach(group => group.members.forEach(member => {
                if (!memberGroupMap.has(member)) memberGroupMap.set(member, group.name);
            }));
            
            const uniqueGroupIds = [...new Set(appState.workRecords.map(r => r.groupId))];
            
            const ongoingRecords = (appState.workRecords || []).filter(r => r.status === 'ongoing');
            const ongoingTaskTypes = new Set(ongoingRecords.map(r => r.task));

            // SECTION 1: ONGOING TASKS
            const ongoingTasksContainer = document.createElement('div');
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex justify-between items-center border-b pb-2 mb-4';
            headerDiv.innerHTML = `<h3 class="text-lg font-bold text-gray-700">진행 중인 업무 (${ongoingTaskTypes.size}개)</h3>`;
            const showHiddenBtn = document.createElement('button');
            showHiddenBtn.id = 'show-hidden-cards-btn';
            showHiddenBtn.className = 'text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded';
            showHiddenBtn.textContent = '완료된 업무 표시/숨기기';
            headerDiv.appendChild(showHiddenBtn);
            ongoingTasksContainer.appendChild(headerDiv);

            const ongoingGrid = document.createElement('div');
            ongoingGrid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';

            if (uniqueGroupIds.length === 0) {
                ongoingGrid.innerHTML = `<p class="text-sm text-gray-400 col-span-full">진행 중인 업무가 없습니다.</p>`;
            } else {
                 uniqueGroupIds.forEach(groupId => {
                    if ((appState.hiddenGroupIds || []).includes(groupId)) return;

                    const groupRecords = appState.workRecords.filter(r => r.groupId === groupId);
                    if (groupRecords.length === 0) return;

                    const firstRecord = groupRecords[0];
                    const isOngoing = groupRecords.some(r => r.status === 'ongoing');

                    let membersHtml = '<div class="space-y-1">';
                    groupRecords.forEach(rec => {
                        const part = memberGroupMap.get(rec.member) || '알바';
                        membersHtml += `
                            <div class="flex justify-between items-center text-sm text-gray-700 hover:bg-gray-100 rounded px-1">
                                <span>
                                    <span class="text-xs font-semibold text-gray-500 w-16 inline-block">${part}</span>
                                    <span>${rec.member}</span>
                                </span>
                                ${rec.status === 'ongoing' ? `<button data-record-id="${rec.id}" class="stop-work-individual-btn text-xs bg-red-100 text-red-700 hover:bg-red-200 px-2 py-0.5 rounded">종료</button>` : ''}
                            </div>
                        `;
                    });
                    membersHtml += '</div>';

                    const card = document.createElement('div');
                    
                    if (isOngoing) {
                        card.className = 'p-4 rounded-lg border flex flex-col justify-between bg-blue-50 border-blue-200';
                        card.innerHTML = `
                            <div>
                                <div class="font-bold text-lg text-blue-800">${firstRecord.task}</div>
                                <div class="text-xs text-gray-500 my-2">
                                    시작: ${formatTimeTo24H(firstRecord.startTime)} 
                                    <span class="ongoing-duration" data-start-time="${firstRecord.startTime}">(진행: 0분)</span>
                                </div>
                                <div class="font-semibold text-gray-600 text-sm mb-2">참여 인원 (${groupRecords.filter(r=>r.status === 'ongoing').length}명):</div>
                                ${membersHtml}
                            </div>
                            <button data-group-id="${firstRecord.groupId}" class="stop-work-group-btn mt-3 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md transition text-sm">그룹 전체 종료</button>
                        `;
                    } else { // Completed card
                         card.className = 'p-4 rounded-lg border flex flex-col justify-between bg-gray-100 border-gray-200 opacity-80';
                          const totalDuration = groupRecords.reduce((sum, r) => sum + r.duration, 0);
                          card.innerHTML = `
                            <div>
                                <div class="font-bold text-lg text-gray-500">${firstRecord.task} (완료)</div>
                                <div class="text-xs text-gray-500 my-2">
                                    ${formatTimeTo24H(firstRecord.startTime)} ~ ${formatTimeTo24H(firstRecord.endTime)}
                                    <span class="font-semibold">(총: ${formatDuration(totalDuration/groupRecords.length)})</span>
                                </div>
                                <div class="font-semibold text-gray-600 text-sm mb-2">참여 인원 (${groupRecords.length}명):</div>
                                ${membersHtml}
                            </div>
                            <button data-group-id="${firstRecord.groupId}" class="hide-completed-group-btn mt-3 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md transition text-sm">숨기기</button>
                        `;
                    }

                    ongoingGrid.appendChild(card);
                });
            }
            ongoingTasksContainer.appendChild(ongoingGrid);
            teamStatusBoard.appendChild(ongoingTasksContainer);

            // SECTION 2: ALL TEAM MEMBER STATUS
            const allMembersContainer = document.createElement('div');
            const allMembersHeader = document.createElement('div');
            allMembersHeader.className = 'flex justify-between items-center border-b pb-2 mb-4 mt-8';
            allMembersHeader.innerHTML = `<h3 class="text-lg font-bold text-gray-700">전체 팀원 현황 (클릭하여 선택)</h3>
                <button id="set-leave-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-sm text-sm">선택 인원 휴무 설정/해제</button>`;
            allMembersContainer.appendChild(allMembersHeader);

            const workingMembers = new Map(ongoingRecords.map(r => [r.member, r.task]));

            teamGroups.forEach(group => {
                const groupContainer = document.createElement('div');
                groupContainer.className = 'mb-4';

                const groupHeader = document.createElement('div');
                groupHeader.className = 'flex items-center gap-2 mb-2';
                groupHeader.innerHTML = `<h4 class="text-md font-semibold text-gray-600">${group.name}</h4>`;

                const selectAllBtn = document.createElement('button');
                selectAllBtn.dataset.groupName = group.name;
                selectAllBtn.className = 'select-all-group-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-0.5 rounded';
                selectAllBtn.textContent = '전체선택';
                groupHeader.appendChild(selectAllBtn);
                groupContainer.appendChild(groupHeader);

                const groupGrid = document.createElement('div');
                groupGrid.className = 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3';
                const uniqueMembersInGroup = [...new Set(group.members)];

                uniqueMembersInGroup.forEach(member => {
                    const card = document.createElement('button');
                    card.type = 'button';
                    card.dataset.memberName = member;

                    const isOnLeave = (appState.onLeaveMembers || []).includes(member);
                    const currentlyWorkingTask = workingMembers.get(member);
                    const isSelected = (appState.selectedForTask || []).includes(member);

                    let classList = 'p-2 rounded-lg border text-center transition-shadow ';
                    if (isSelected) {
                        classList += 'ring-2 ring-offset-1 ring-blue-500 ';
                    }

                    if (isOnLeave) {
                        card.className = classList + 'bg-gray-800 border-gray-700 text-gray-400';
                        card.innerHTML = `<div class="font-semibold text-sm">${member}</div><div class="text-xs mt-1">휴무</div>`;
                    } else if (currentlyWorkingTask) {
                        card.className = classList + 'bg-red-50 border-red-200';
                        let displayTask = `${currentlyWorkingTask} 중`;
                        card.innerHTML = `<div class="flex items-center justify-center gap-1.5"><span class="w-2 h-2 rounded-full bg-red-500"></span><div class="font-semibold text-sm text-red-800">${member}</div></div><div class="text-xs text-gray-600 truncate mt-1" title="${currentlyWorkingTask}">${displayTask}</div>`;
                    } else {
                        card.className = classList + 'bg-green-50 border-green-200';
                        card.innerHTML = `<div class="flex items-center justify-center gap-1.5"><span class="w-2 h-2 rounded-full bg-green-500"></span><div class="font-semibold text-sm text-green-800">${member}</div></div><div class="text-xs text-green-600 mt-1">대기 중</div>`;
                    }
                    groupGrid.appendChild(card);
                });
                groupContainer.appendChild(groupGrid);
                allMembersContainer.appendChild(groupContainer);
            });
            
            const workingAlba = ongoingRecords.filter(r => r.member.startsWith('알바'));
            if (workingAlba.length > 0) {
                const albaContainer = document.createElement('div');
                albaContainer.className = 'mb-4';
                albaContainer.innerHTML = `<h4 class="text-md font-semibold text-gray-600 mb-2">알바</h4>`;
                const albaGrid = document.createElement('div');
                albaGrid.className = 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3';
                
                const uniqueAlba = [...new Set(workingAlba.map(r => r.member))];

                uniqueAlba.forEach(albaMember => {
                    const card = document.createElement('div');
                    const currentlyWorkingTask = workingMembers.get(albaMember);
                    let displayTask = `${currentlyWorkingTask} 중`;
                    card.className = 'p-2 rounded-lg border bg-red-50 border-red-200 text-center';
                    card.innerHTML = `<div class="flex items-center justify-center gap-1.5"><span class="w-2 h-2 rounded-full bg-red-500"></span><div class="font-semibold text-sm text-red-800">${albaMember}</div></div><div class="text-xs text-gray-600 truncate mt-1" title="${currentlyWorkingTask}">${displayTask}</div>`;
                    albaGrid.appendChild(card);
                });

                albaContainer.appendChild(albaGrid);
                allMembersContainer.appendChild(albaContainer);
            }

            teamStatusBoard.appendChild(allMembersContainer);
        };

        const renderCompletedWorkLog = () => {
            const workLogBody = document.getElementById('work-log-body');
            workLogBody.innerHTML = '';
            const completedRecords = (appState.workRecords || []).filter(r => r.status === 'completed');
            const groupedRecords = completedRecords.reduce((acc, record) => {
                (acc[record.task] = acc[record.task] || []).push(record);
                return acc;
            }, {});
            const sortedTasks = Object.keys(groupedRecords).sort();

            if (sortedTasks.length === 0) {
                workLogBody.innerHTML = `<tr><td colspan="6" class="text-center py-12 text-gray-400">완료된 업무가 없습니다.</td></tr>`;
            } else {
                sortedTasks.forEach(task => {
                    const groupHeaderRow = document.createElement('tr');
                    groupHeaderRow.className = 'bg-gray-100';
                    groupHeaderRow.innerHTML = `<th colspan="6" class="px-6 py-3 text-left text-base text-blue-700 font-bold">${task}</th>`;
                    workLogBody.appendChild(groupHeaderRow);
                    groupedRecords[task].sort((a,b) => a.startTime.localeCompare(b.startTime)).forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b border-gray-200 hover:bg-gray-50';
                        row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900">${record.member}</td><td class="px-6 py-4">${record.task}</td><td class="px-6 py-4">${formatTimeTo24H(record.startTime)}</td><td class="px-6 py-4">${formatTimeTo24H(record.endTime)}</td><td class="px-6 py-4">${formatDuration(record.duration)}</td><td class="px-6 py-4 text-right space-x-2"><button class="font-medium text-blue-500 hover:underline" onclick="editRecord(${record.id})">수정</button><button class="font-medium text-red-500 hover:underline" onclick="deleteRecord(${record.id})">삭제</button></td>`;
                        workLogBody.appendChild(row);
                    });
                });
            }
        };

        const updateSummary = () => {
            const ongoingRecords = (appState.workRecords || []).filter(r => r.status === 'ongoing');
            const workingMembers = new Set(ongoingRecords.map(r => r.member));
            const allMembers = new Set(teamGroups.flatMap(g => g.members));
            
            const totalStaff = allMembers.size;
            const onLeaveCount = (appState.onLeaveMembers || []).length;
            const workingCount = workingMembers.size;
            const activeStaff = totalStaff - onLeaveCount; // 근무
            const idleCount = activeStaff - workingCount;
            const ongoingTaskCount = new Set(ongoingRecords.map(r => r.task)).size;

            document.getElementById('summary-total-staff').textContent = `${totalStaff}`;
            document.getElementById('summary-leave-staff').textContent = `${onLeaveCount}`;
            document.getElementById('summary-active-staff').textContent = `${activeStaff}`;
            document.getElementById('summary-working-staff').textContent = `${workingCount}`;
            document.getElementById('summary-idle-staff').textContent = `${idleCount}`;
            document.getElementById('summary-ongoing-tasks').textContent = `${ongoingTaskCount}`;
        };

        // --- Main Logic & Firebase Integration ---
        window.deleteRecord = (id) => {
            deleteMode = 'single';
            recordToDeleteId = id;
            document.getElementById('delete-confirm-message').textContent = '정말로 이 기록을 삭제하시겠습니까?';
            deleteConfirmModal.classList.remove('hidden');
        };
        
        window.editRecord = (id) => {
            recordToEditId = id;
            const record = appState.workRecords.find(r => r.id === id);
            if (!record) return;

            document.getElementById('edit-member-name').value = record.member;
            
            const taskSelect = document.getElementById('edit-task-type');
            taskSelect.innerHTML = '';
            Object.entries(taskGroups).forEach(([groupName, tasks]) => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = groupName;
                tasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task;
                    option.textContent = task;
                    if (task === record.task) {
                        option.selected = true;
                    }
                    optgroup.appendChild(option);
                });
                taskSelect.appendChild(optgroup);
            });


            document.getElementById('edit-start-time').value = record.startTime;
            document.getElementById('edit-end-time').value = record.endTime;

            editRecordModal.classList.remove('hidden');
        };

        const startWorkGroup = (members, task) => {
            const groupId = Date.now();
            const startTime = getCurrentTime();
            const newRecords = members.map(member => ({
                id: groupId + Math.random(),
                member,
                task,
                startTime,
                endTime: null,
                duration: null,
                status: 'ongoing',
                groupId
            }));
            appState.workRecords.push(...newRecords);
            saveStateToFirestore();
        };

        const stopWorkGroup = (groupId) => {
            const records = appState.workRecords.filter(r => r.groupId === groupId && r.status === 'ongoing');
            if (records.length === 0) return;

            const taskName = records[0].task;
            if (quantityTaskTypes.includes(taskName)) {
                groupToStopId = groupId;
                document.getElementById('quantity-on-stop-task-name').textContent = taskName;
                document.getElementById('quantity-on-stop-input').value = '';
                quantityOnStopModal.classList.remove('hidden');
            } else {
                finalizeStopGroup(groupId, null);
            }
        };

        const finalizeStopGroup = (groupId, quantity) => {
            const endTime = getCurrentTime();
            let taskName = '';
            appState.workRecords.forEach(record => {
                if (record.groupId === groupId && record.status === 'ongoing') {
                    taskName = record.task;
                    record.status = 'completed';
                    record.endTime = endTime;
                    const start = new Date(`1970-01-01T${record.startTime}`);
                    const end = new Date(`1970-01-01T${endTime}`);
                    record.duration = (end - start) / (1000 * 60);
                }
            });

            if (quantity !== null && taskName) {
                appState.taskQuantities[taskName] = (appState.taskQuantities[taskName] || 0) + quantity;
            }

            if (!appState.hiddenGroupIds.includes(groupId)) {
                appState.hiddenGroupIds.push(groupId);
            }

            saveStateToFirestore();
            quantityOnStopModal.classList.add('hidden');
            groupToStopId = null;
        }

        const stopWorkIndividual = (recordId) => {
            const endTime = getCurrentTime();
            const record = appState.workRecords.find(r => r.id === recordId);
            if (record && record.status === 'ongoing') {
                record.status = 'completed';
                record.endTime = endTime;
                const start = new Date(`1970-01-01T${record.startTime}`);
                const end = new Date(`1970-01-01T${endTime}`);
                record.duration = (end - start) / (1000 * 60);
                
                const remainingOngoing = appState.workRecords.some(r => r.groupId === record.groupId && r.status === 'ongoing');
                if (!remainingOngoing) {
                    if (!appState.hiddenGroupIds.includes(record.groupId)) {
                        appState.hiddenGroupIds.push(record.groupId);
                    }
                }

                saveStateToFirestore();
                showToast(`${record.member}님의 ${record.task} 업무가 종료되었습니다.`);
            }
        };
        
        // --- Firebase Functions ---
        async function fetchAppConfig() {
            const configDocRef = doc(db, "artifacts", APP_ID, "config", "wages");
            try {
                const docSnap = await getDoc(configDocRef);
                if (docSnap.exists() && Object.keys(docSnap.data()).length > 0) {
                    appConfig.memberWages = docSnap.data();
                } else {
                    console.warn("Wages configuration not found in Firestore or is empty. Using default values.");
                    appConfig.memberWages = defaultMemberWages; 
                }
            } catch (error) {
                console.error("Error fetching config, using default values:", error);
                appConfig.memberWages = defaultMemberWages;
            }
        }
        
        async function saveStateToFirestore() {
            if (!auth || !auth.currentUser) return;
            const docRef = doc(db, "artifacts", APP_ID, "daily_data", getTodayDateString());
            await setDoc(docRef, { state: JSON.stringify(appState) });
        }

        async function saveProgress() {
            const dateStr = getTodayDateString();
            showToast(`현재까지 완료된 기록을 저장합니다...`);

            const historyDocRef = doc(db, "artifacts", APP_ID, "history", dateStr);

            try {
                const docSnap = await getDoc(historyDocRef);
                const existingData = docSnap.exists() ? docSnap.data() : { workRecords: [], taskQuantities: {} };

                const completedRecordsFromState = appState.workRecords.filter(r => r.status === 'completed');
                
                if (completedRecordsFromState.length === 0 && Object.values(appState.taskQuantities).every(q => (parseInt(q,10) || 0) === 0)) {
                    return showToast('저장할 새로운 완료 기록이 없습니다.', true);
                }

                const combinedRecords = [...(existingData.workRecords || []), ...completedRecordsFromState];
                const uniqueRecords = Array.from(new Map(combinedRecords.map(item => [item.id, item])).values());
                const finalQuantities = { ...(existingData.taskQuantities || {}), ...appState.taskQuantities };

                const dataToSave = {
                    workRecords: uniqueRecords,
                    taskQuantities: finalQuantities,
                    onLeaveMembers: appState.onLeaveMembers || []
                };

                await setDoc(historyDocRef, dataToSave);
                showToast(`현재까지의 기록이 성공적으로 저장되었습니다.`);

            } catch (e) {
                console.error("Error in saveProgress: ", e);
                showToast(`중간 저장 중 오류가 발생했습니다: ${e.message}`, true);
            }
        }
        
        async function saveDayDataToHistory(shouldReset) {
            await saveProgress(); 
            const ongoingRecords = appState.workRecords.filter(r => r.status === 'ongoing');
            if (ongoingRecords.length > 0) {
                 ongoingRecords.forEach(rec => {
                     const endTime = getCurrentTime();
                     rec.status = 'completed';
                     rec.endTime = endTime;
                     const start = new Date(`1970-01-01T${rec.startTime}`);
                     const end = new Date(`1970-01-01T${endTime}`);
                     rec.duration = (end - start) / (1000 * 60);
                 });
                 await saveProgress();
            }

            if(shouldReset){
                appState.workRecords = [];
                appState.taskQuantities = {};
                appState.selectedForTask = [];
                appState.hiddenGroupIds = [];
                taskTypes.forEach(task => {
                    appState.taskQuantities[task] = 0;
                });
                
                await saveStateToFirestore();
                showToast(`오늘의 업무 기록을 초기화했습니다.`);
            }
        }

        // --- History View Functions ---

        async function fetchAllHistoryData() {
            if (allHistoryData.length > 0) return allHistoryData; // Use cache if available
            
            const historyCollectionRef = collection(db, "artifacts", APP_ID, "history");
            try {
                const querySnapshot = await getDocs(historyCollectionRef);
                allHistoryData = [];
                querySnapshot.forEach((doc) => {
                    allHistoryData.push({ id: doc.id, ...doc.data() });
                });
                return allHistoryData;
            } catch (error) {
                console.error("Error fetching all history data:", error);
                showToast("전체 이력 로딩 실패", true);
                return [];
            }
        }

        const loadAndRenderHistoryList = async () => {
            historyDateList.innerHTML = '<li><div class="p-4 text-center text-gray-500">이력 로딩 중...</div></li>';
            allHistoryData = []; // Clear cache on open
            const historyData = await fetchAllHistoryData();

            if (historyData.length === 0) {
                historyDateList.innerHTML = '<li><div class="p-4 text-center text-gray-500">저장된 이력이 없습니다.</div></li>';
                 document.getElementById('history-daily-view').innerHTML = '';
                 document.getElementById('history-weekly-view').innerHTML = '';
                 document.getElementById('history-monthly-view').innerHTML = '';
                return;
            }

            const dates = historyData.map(d => d.id).sort((a, b) => b.localeCompare(a));
            
            historyDateList.innerHTML = '';
            dates.forEach(dateKey => {
                const li = document.createElement('li');
                li.innerHTML = `<button data-key="${dateKey}" class="w-full text-left p-3 rounded-md hover:bg-blue-100 transition focus:outline-none focus:ring-2 focus:ring-blue-300">${dateKey}</button>`;
                historyDateList.appendChild(li);
            });
            
            if (historyDateList.firstChild) {
                historyDateList.firstChild.querySelector('button').click();
            }
        };

        window.openHistoryQuantityModal = (dateKey) => {
              const data = allHistoryData.find(d => d.id === dateKey);
              if (!data) return;

              renderQuantityModalInputs(data.taskQuantities || {});
              
              document.getElementById('quantity-modal-title').textContent = `${dateKey} 처리량 수정`;
              
              quantityModalContext = {
                  mode: 'history',
                  dateKey: dateKey,
                  onConfirm: async (newQuantities) => {
                      const dataToUpdate = allHistoryData.find(d => d.id === dateKey);
                      dataToUpdate.taskQuantities = newQuantities;
                      const historyDocRef = doc(db, "artifacts", APP_ID, "history", dateKey);
                      await setDoc(historyDocRef, dataToUpdate);
                      showToast(`${dateKey}의 처리량이 수정되었습니다.`);
                      renderHistoryDetail(dateKey);
                  },
                  onCancel: () => { /* Just close */ }
              };
              
              document.getElementById('confirm-quantity-btn').textContent = "수정 저장";
              document.getElementById('cancel-quantity-btn').textContent = "취소";
              quantityModal.classList.remove('hidden');
        };
        
        const renderHistoryDetail = async (dateKey) => {
            const view = document.getElementById('history-daily-view');
            view.innerHTML = `<div class="text-center text-gray-500">데이터 로딩 중...</div>`;
            
            const data = allHistoryData.find(d => d.id === dateKey);

            if (!data) {
                view.innerHTML = `<div class="text-center text-red-500">해당 날짜의 데이터를 찾을 수 없습니다.</div>`;
                return;
            }

            const records = data.workRecords || [];
            const quantities = data.taskQuantities || {};
            const onLeaveMembers = data.onLeaveMembers || [];
            
            const allRegularMembers = new Set(teamGroups.flatMap(g => g.members));
            const activeMembersCount = allRegularMembers.size - (onLeaveMembers || []).length;

            const totalSumDuration = records.reduce((sum, r) => sum + r.duration, 0);

            const completedGroups = {};
            records.forEach(record => {
                if (!completedGroups[record.groupId]) {
                    completedGroups[record.groupId] = record.duration;
                }
            });
            const totalOverallDuration = Object.values(completedGroups).reduce((sum, duration) => sum + duration, 0);


            const totalQuantity = Object.values(quantities).reduce((sum, q) => sum + (parseInt(q, 10) || 0), 0);
            const avgThroughput = totalSumDuration > 0 ? (totalQuantity / totalSumDuration).toFixed(2) : '0.00';
            const taskDurations = records.reduce((acc, rec) => {
                acc[rec.task] = (acc[rec.task] || 0) + rec.duration;
                return acc;
            }, {});
            
            let nonWorkHtml = '';
            if (isWeekday(dateKey)) {
                const totalPotentialMinutes = activeMembersCount * 8 * 60;
                const nonWorkMinutes = totalPotentialMinutes - totalSumDuration;
                const percentage = totalPotentialMinutes > 0 ? (nonWorkMinutes / totalPotentialMinutes * 100).toFixed(1) : 0;
                nonWorkHtml = `<div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <h4 class="text-sm font-semibold text-gray-500">총 비업무시간</h4>
                    <p class="text-xl font-bold text-gray-700">${formatDuration(nonWorkMinutes > 0 ? nonWorkMinutes : 0)}</p>
                    <p class="text-xs text-gray-500 mt-1">총 ${formatDuration(totalPotentialMinutes)} 중 (${percentage}%)</p>
                </div>`;
            } else {
                nonWorkHtml = `<div class="bg-white p-4 rounded-lg shadow-sm text-center flex flex-col justify-center items-center">
                    <h4 class="text-sm font-semibold text-gray-500">총 비업무시간</h4>
                    <p class="text-lg font-bold text-gray-400">주말</p>
                </div>`;
            }

            let html = `
                <div class="mb-6 pb-4 border-b flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">${dateKey}</h3>
                    <div>
                        <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-md text-sm" onclick="openHistoryQuantityModal('${dateKey}')">처리량 수정</button>
                        <button class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md text-sm ml-2" onclick="downloadHistoryAsExcel('${dateKey}')">엑셀</button>
                        <button class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-sm ml-2" onclick="requestHistoryDeletion('${dateKey}')">삭제</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h4 class="text-sm font-semibold text-gray-500">총 투입 인원</h4><p class="text-2xl font-bold text-gray-800">${activeMembersCount} 명</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h4 class="text-sm font-semibold text-gray-500">총합 시간</h4><p class="text-2xl font-bold text-gray-800">${formatDuration(totalSumDuration)}</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h4 class="text-sm font-semibold text-gray-500">전체 시간</h4><p class="text-2xl font-bold text-gray-800">${formatDuration(totalOverallDuration)}</p></div>
                    ${nonWorkHtml}
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h4 class="text-sm font-semibold text-gray-500">총 처리량</h4><p class="text-2xl font-bold text-gray-800">${totalQuantity} 개</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h4 class="text-sm font-semibold text-gray-500">분당 평균 처리량</h4><p class="text-2xl font-bold text-gray-800">${avgThroughput} 개/분</p></div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <h4 class="text-lg font-bold mb-3 text-gray-700">업무별 처리량</h4>
                    <div class="space-y-2">
            `;
            let hasRawQuantities = false;
            Object.entries(quantities).forEach(([task, qty]) => {
                if(parseInt(qty, 10) > 0) {
                    hasRawQuantities = true;
                    html += `<div class="flex justify-between items-center text-sm border-b pb-2"><span class="font-semibold text-gray-600">${task}</span><span>${qty} 개</span></div>`;
                }
            });
            if (!hasRawQuantities) {
                html += `<p class="text-gray-500 text-sm">입력된 처리량이 없습니다.</p>`;
            }
            html += `</div></div>`;

            html += `<div class="bg-white p-4 rounded-lg shadow-sm mb-6"><h4 class="text-lg font-bold mb-3 text-gray-700">업무별 분당 처리량</h4><div class="space-y-2">`;
            let hasQuantities = false;
             Object.entries(quantities).forEach(([task, qty]) => {
                if(parseInt(qty, 10) > 0) {
                    hasQuantities = true;
                    const durationForTask = taskDurations[task] || 0;
                    const throughputForTask = durationForTask > 0 ? ((parseInt(qty, 10) || 0) / durationForTask).toFixed(2) : '0.00';
                    html += `<div class="flex justify-between items-center text-sm border-b pb-2"><span class="font-semibold text-gray-600">${task}</span><span>${throughputForTask} 개/분</span></div>`;
                }
            });
            if (!hasQuantities) {
                html += `<p class="text-gray-500 text-sm">입력된 처리량이 없습니다.</p>`;
            }
            html += `</div></div>`;

            html += `<div class="bg-white p-4 rounded-lg shadow-sm"><h4 class="text-lg font-bold mb-3 text-gray-700">업무별 시간 비중</h4><div class="space-y-3">`;
            Object.entries(taskDurations).sort(([,a],[,b]) => b - a).forEach(([task, duration]) => {
                const percentage = totalSumDuration > 0 ? (duration / totalSumDuration * 100).toFixed(1) : 0;
                html += `
                    <div>
                        <div class="flex justify-between items-center mb-1 text-sm">
                            <span class="font-semibold text-gray-600">${task}</span>
                            <span>${formatDuration(duration)} (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                    </div>
                `;
            });
            html += `</div></div>`;

            view.innerHTML = html;
        };

        const renderSummaryView = (viewType, data, key) => {
            const totalDuration = (data.workRecords || []).reduce((sum, r) => sum + r.duration, 0);
            const totalQuantity = Object.values(data.taskQuantities || {}).reduce((sum, q) => sum + (parseInt(q,10) || 0), 0);
            const avgThroughput = totalDuration > 0 ? (totalQuantity / totalDuration).toFixed(2) : '0.00';
            const taskDurations = (data.workRecords || []).reduce((acc, rec) => {
                acc[rec.task] = (acc[rec.task] || 0) + rec.duration;
                return acc;
            }, {});

            let html = `
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="pb-3 border-b mb-3">
                        <div class="flex justify-between items-baseline">
                             <h3 class="text-xl font-bold text-blue-600">${key}</h3>
                             <span class="text-lg font-semibold text-gray-800">${avgThroughput} <span class="text-sm font-normal text-gray-500">개/분</span></span>
                        </div>
                        <div class="text-sm text-gray-500 mt-1">
                            <span>총 업무 시간: ${formatDuration(totalDuration)}</span>
                            <span class="mx-2">|</span>
                            <span>총 처리량: ${totalQuantity} 개</span>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-md font-bold mb-2 text-gray-600">업무별 분당 처리량</h4>
                        <div class="space-y-1">
            `;

            let hasQuantities = false;
            Object.entries(data.taskQuantities || {}).forEach(([task, qty]) => {
                if (parseInt(qty, 10) > 0) {
                    hasQuantities = true;
                    const durationForTask = taskDurations[task] || 0;
                    const throughputForTask = durationForTask > 0 ? (qty / durationForTask).toFixed(2) : '0.00';
                    html += `<div class="flex justify-between items-center text-sm text-gray-700"><span class="font-medium">${task}</span><span>${throughputForTask} 개/분</span></div>`;
                }
            });
             if (!hasQuantities) {
                html += `<p class="text-gray-500 text-sm">입력된 처리량이 없습니다.</p>`;
            }

            html += `</div></div></div>`;
            return html;
        };

        const renderWeeklyHistory = async () => {
            const view = document.getElementById('history-weekly-view');
            view.innerHTML = `<div class="text-center text-gray-500">주별 데이터 집계 중...</div>`;
            
            const weeklyData = allHistoryData.reduce((acc, day) => {
                const weekKey = getWeekOfYear(new Date(day.id));
                if (!acc[weekKey]) acc[weekKey] = { workRecords: [], taskQuantities: {} };
                acc[weekKey].workRecords.push(...day.workRecords);
                Object.entries(day.taskQuantities).forEach(([task, qty]) => {
                    acc[weekKey].taskQuantities[task] = (acc[weekKey].taskQuantities[task] || 0) + (parseInt(qty, 10) || 0);
                });
                return acc;
            }, {});

            const sortedWeeks = Object.keys(weeklyData).sort((a,b) => b.localeCompare(a));
            if(sortedWeeks.length === 0) {
                view.innerHTML = `<div class="text-center text-gray-500">주별 데이터가 없습니다.</div>`;
                return;
            }

            view.innerHTML = sortedWeeks.map(weekKey => renderSummaryView('weekly', weeklyData[weekKey], weekKey)).join('');
        };

        const renderMonthlyHistory = async () => {
             const view = document.getElementById('history-monthly-view');
            view.innerHTML = `<div class="text-center text-gray-500">월별 데이터 집계 중...</div>`;

            const monthlyData = allHistoryData.reduce((acc, day) => {
                const monthKey = day.id.substring(0, 7); // YYYY-MM
                if (!acc[monthKey]) acc[monthKey] = { workRecords: [], taskQuantities: {} };
                acc[monthKey].workRecords.push(...day.workRecords);
                 Object.entries(day.taskQuantities).forEach(([task, qty]) => {
                    acc[monthKey].taskQuantities[task] = (acc[monthKey].taskQuantities[task] || 0) + (parseInt(qty, 10) || 0);
                });
                return acc;
            }, {});

            const sortedMonths = Object.keys(monthlyData).sort((a, b) => b.localeCompare(a));
            if(sortedMonths.length === 0) {
                view.innerHTML = `<div class="text-center text-gray-500">월별 데이터가 없습니다.</div>`;
                return;
            }

            view.innerHTML = sortedMonths.map(monthKey => renderSummaryView('monthly', monthlyData[monthKey], monthKey)).join('');
        };
        
        window.requestHistoryDeletion = (dateKey) => {
            historyKeyToDelete = dateKey;
            deleteHistoryModal.classList.remove('hidden');
        };

        window.downloadHistoryAsExcel = async (dateKey) => {
            try {
                const data = allHistoryData.find(d => d.id === dateKey);
                if (!data || !data.workRecords || data.workRecords.length === 0) {
                    return showToast('다운로드할 데이터가 없습니다.', true);
                }
                const records = data.workRecords;

                // --- Helper for appending total row ---
                const appendTotalRow = (ws, data, headers) => {
                    if (!data || data.length === 0) return;
                    const total = {};
                    headers.forEach((header, index) => {
                        if (index === 0) {
                            total[header] = '총 합계';
                        } else {
                            const sum = data.reduce((acc, row) => acc + (Number(row[header]) || 0), 0);
                            total[header] = sum;
                        }
                    });
                    XLSX.utils.sheet_add_json(ws, [total], { skipHeader: true, origin: -1 });
                };

                // --- Sheet 1: 상세 기록 ---
                const sheet1Headers = ['팀원', '업무 종류', '시작 시간', '종료 시간', '소요 시간(분)'];
                const sheet1Data = records.map(r => ({
                    '팀원': r.member, '업무 종류': r.task, '시작 시간': formatTimeTo24H(r.startTime),
                    '종료 시간': formatTimeTo24H(r.endTime), '소요 시간(분)': Math.round(r.duration)
                }));
                const worksheet1 = XLSX.utils.json_to_sheet(sheet1Data, { header: sheet1Headers });
                appendTotalRow(worksheet1, sheet1Data, sheet1Headers);


                // --- Sheet 2: 업무별 요약 ---
                const sheet2Headers = ['업무 종류', '총 소요 시간(분)', '총 인건비(원)'];
                const summaryByTask = {};
                records.forEach(r => {
                    if (!summaryByTask[r.task]) {
                        summaryByTask[r.task] = { totalDuration: 0, totalCost: 0 };
                    }
                    const wage = appConfig.memberWages[r.member] || 0;
                    const cost = (r.duration / 60) * wage;
                    summaryByTask[r.task].totalDuration += r.duration;
                    summaryByTask[r.task].totalCost += cost;
                });
                const sheet2Data = Object.keys(summaryByTask).sort().map(task => ({
                    '업무 종류': task, '총 소요 시간(분)': Math.round(summaryByTask[task].totalDuration),
                    '총 인건비(원)': Math.round(summaryByTask[task].totalCost)
                }));
                const worksheet2 = XLSX.utils.json_to_sheet(sheet2Data, { header: sheet2Headers });
                appendTotalRow(worksheet2, sheet2Data, sheet2Headers);

                // --- Sheet 3: 파트별 인건비 ---
                const sheet3Headers = ['파트', '총 인건비(원)'];
                const memberToPartMap = new Map();
                teamGroups.forEach(group => {
                    group.members.forEach(member => memberToPartMap.set(member, group.name));
                });
                const summaryByPart = {};
                records.forEach(r => {
                    const part = memberToPartMap.get(r.member) || '기타';
                    if (!summaryByPart[part]) summaryByPart[part] = { totalCost: 0 };
                    const wage = appConfig.memberWages[r.member] || 0;
                    const cost = (r.duration / 60) * wage;
                    summaryByPart[part].totalCost += cost;
                });
                const sheet3Data = Object.keys(summaryByPart).sort().map(part => ({
                    '파트': part,
                    '총 인건비(원)': Math.round(summaryByPart[part].totalCost)
                }));
                 const worksheet3 = XLSX.utils.json_to_sheet(sheet3Data, { header: sheet3Headers });
                 appendTotalRow(worksheet3, sheet3Data, sheet3Headers);

                // --- Auto-fit column widths for all sheets ---
                const fitToColumn = (ws) => {
                    const objectMaxLength = [];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    data.forEach(row => {
                        Object.keys(row).forEach(key => {
                            if (typeof objectMaxLength[key] === 'undefined') {
                                objectMaxLength[key] = 10;
                            }
                            if (row[key] !== null) {
                                objectMaxLength[key] = Math.max(objectMaxLength[key], String(row[key]).length);
                            }
                        });
                    });
                    ws["!cols"] = objectMaxLength.map(w => ({ width: w + 2 }));
                };
                fitToColumn(worksheet1);
                fitToColumn(worksheet2);
                fitToColumn(worksheet3);


                // --- Create Workbook and Download ---
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet1, '상세 기록');
                XLSX.utils.book_append_sheet(workbook, worksheet2, '업무별 요약');
                XLSX.utils.book_append_sheet(workbook, worksheet3, '파트별 인건비');
                XLSX.writeFile(workbook, `업무기록_${dateKey}.xlsx`);

            } catch (error) {
                console.error("Excel export failed:", error);
                showToast("Excel 파일 생성에 실패했습니다.", true);
            }
        };

        // --- Event Listeners ---
        document.getElementById('work-start-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const task = selectedTaskForStart;
            if (!task) {
                return showToast('업무 종류를 선택해주세요.', true);
            }
            const partTimerCount = parseInt(document.getElementById('part-timer-count').value, 10) || 0;
            
            const membersToStart = [...(appState.selectedForTask || [])];
            for (let i = 1; i <= partTimerCount; i++) {
                membersToStart.push(`알바 ${i}`);
            }

            if (membersToStart.length === 0) {
                return showToast('업무를 시작할 팀원을 선택해주세요.', true);
            }
            startWorkGroup(membersToStart, task);
            
            appState.selectedForTask = [];
            selectedTaskForStart = null;
            document.getElementById('open-task-modal-btn').textContent = '업무를 선택하세요';
            document.getElementById('part-timer-count').value = 0;
            showToast(`${task} 업무를 시작합니다.`);
            renderRealtimeStatus(); 
        });
        
        teamStatusBoard.addEventListener('click', (e) => {
            const stopGroupButton = e.target.closest('.stop-work-group-btn');
            if (stopGroupButton) {
                const groupId = parseFloat(stopGroupButton.dataset.groupId);
                stopWorkGroup(groupId);
                return;
            }

            const stopIndividualButton = e.target.closest('.stop-work-individual-btn');
            if (stopIndividualButton) {
                const recordId = parseFloat(stopIndividualButton.dataset.recordId);
                stopWorkIndividual(recordId);
                return;
            }
            
            const memberButton = e.target.closest('[data-member-name]');
            if (memberButton) {
                const memberName = memberButton.dataset.memberName;

                const ongoingRecords = (appState.workRecords || []).filter(r => r.status === 'ongoing');
                const memberIsWorkingRecord = ongoingRecords.find(r => r.member === memberName);

                if (memberIsWorkingRecord) {
                    // If member is working, show confirmation modal to stop their work
                    recordToStopId = memberIsWorkingRecord.id;
                    stopIndividualConfirmMessage.textContent = `${memberIsWorkingRecord.member}님의 '${memberIsWorkingRecord.task}' 업무를 종료하시겠습니까?`;
                    stopIndividualConfirmModal.classList.remove('hidden');
                } else {
                    // If member is idle, toggle selection for a new task
                    const index = (appState.selectedForTask || []).indexOf(memberName);
                    if (index > -1) {
                        appState.selectedForTask.splice(index, 1);
                    } else {
                        appState.selectedForTask.push(memberName);
                    }
                    renderRealtimeStatus(); // Re-render to show selection change
                }
                return;
            }

            const selectAllButton = e.target.closest('.select-all-group-btn');
            if (selectAllButton) {
                const groupName = selectAllButton.dataset.groupName;
                const group = teamGroups.find(g => g.name === groupName);
                if (!group) return;

                const activeMembersInGroup = group.members.filter(m => !(appState.onLeaveMembers || []).includes(m) && !m.startsWith('알바'));
                const allSelected = activeMembersInGroup.every(m => (appState.selectedForTask || []).includes(m));

                if (allSelected) { 
                    appState.selectedForTask = appState.selectedForTask.filter(m => !activeMembersInGroup.includes(m));
                } else { 
                    activeMembersInGroup.forEach(m => {
                        if (!(appState.selectedForTask || []).includes(m)) {
                            appState.selectedForTask.push(m);
                        }
                    });
                }
                renderRealtimeStatus();
                return;
            }
            
            const showHiddenButton = e.target.closest('#show-hidden-cards-btn');
            if (showHiddenButton) {
                const allCompletedGroupIds = [...new Set(appState.workRecords.filter(r => r.status === 'completed').map(r => r.groupId))];
                
                const allHidden = allCompletedGroupIds.every(id => (appState.hiddenGroupIds || []).includes(id));
                
                if (allHidden) { 
                  appState.hiddenGroupIds = (appState.hiddenGroupIds || []).filter(id => !allCompletedGroupIds.includes(id));
                } else { 
                  allCompletedGroupIds.forEach(id => { 
                    if (!(appState.hiddenGroupIds || []).includes(id)) {
                        appState.hiddenGroupIds.push(id); 
                    }
                  });
                }
                renderRealtimeStatus();
                return;
            }

            const hideCardButton = e.target.closest('.hide-completed-group-btn');
            if (hideCardButton) {
                const groupId = parseFloat(hideCardButton.dataset.groupId);
                if (!appState.hiddenGroupIds.includes(groupId)) {
                    appState.hiddenGroupIds.push(groupId);
                }
                renderRealtimeStatus();
            }

            const setLeaveBtn = e.target.closest('#set-leave-btn');
            if(setLeaveBtn) {
                 const selected = appState.selectedForTask || [];
                 if (selected.length === 0) {
                     return showToast('휴무 처리/해제할 팀원을 선택해주세요.', true);
                 }
                 selected.forEach(name => {
                     const index = (appState.onLeaveMembers || []).indexOf(name);
                     if (index > -1) {
                         appState.onLeaveMembers.splice(index, 1);
                     } else {
                         appState.onLeaveMembers.push(name);
                     }
                 });
                 appState.selectedForTask = [];
                 saveStateToFirestore();
                 showToast('선택된 인원의 휴무 상태가 변경되었습니다.');
                 renderRealtimeStatus();
            }
        });
        
        deleteAllCompletedBtn.addEventListener('click', () => {
            deleteMode = 'all';
            document.getElementById('delete-confirm-message').textContent = '정말로 오늘 완료된 모든 기록을 삭제하시겠습니까?';
            deleteConfirmModal.classList.remove('hidden');
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteMode === 'single' && recordToDeleteId !== null) {
                appState.workRecords = appState.workRecords.filter(record => record.id !== recordToDeleteId);
                showToast('기록이 삭제되었습니다.');
            } else if (deleteMode === 'all') {
                appState.workRecords = appState.workRecords.filter(record => record.status !== 'completed');
                showToast('완료된 모든 기록이 삭제되었습니다.');
            }
            saveStateToFirestore();
            deleteConfirmModal.classList.add('hidden');
            recordToDeleteId = null;
        });
        
        endShiftBtn.addEventListener('click', () => {
            renderQuantityModalInputs(appState.taskQuantities);
            document.getElementById('quantity-modal-title').textContent = "업무 마감 전 처리량 입력";
            document.getElementById('confirm-quantity-btn').textContent = "저장하고 마감";
            document.getElementById('cancel-quantity-btn').textContent = "저장 없이 마감";

            quantityModalContext = {
                mode: 'end-shift',
                onConfirm: (newQuantities) => {
                    appState.taskQuantities = newQuantities;
                    saveDayDataToHistory(true);
                },
                onCancel: () => {
                    saveDayDataToHistory(true);
                }
            };
            quantityModal.classList.remove('hidden');
        });
        
        saveProgressBtn.addEventListener('click', saveProgress);

        openHistoryBtn.addEventListener('click', () => {
            loadAndRenderHistoryList();
            historyModal.classList.remove('hidden');
        });
        
        historyDateList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) {
                document.querySelectorAll('#history-date-list button').forEach(btn => btn.classList.remove('bg-blue-100', 'font-bold'));
                button.classList.add('bg-blue-100', 'font-bold');
                switchHistoryView('daily');
                renderHistoryDetail(button.dataset.key);
            }
        });
        
        historyTabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                switchHistoryView(e.target.dataset.view);
            }
        });
        
        resetAppBtn.addEventListener('click', () => {
            resetAppModal.classList.remove('hidden');
        });

        confirmResetAppBtn.addEventListener('click', async () => {
            try {
                const docRef = doc(db, "artifacts", APP_ID, "daily_data", getTodayDateString());
                await deleteDoc(docRef);
                showToast('데이터가 초기화되었습니다. 새로고침합니다.');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                console.error("Error resetting data:", error);
                showToast('초기화 중 오류가 발생했습니다.', true);
            }
            resetAppModal.classList.add('hidden');
        });

        const switchHistoryView = (view) => {
            const dateListContainer = document.getElementById('history-date-list-container');
            if (dateListContainer) {
                 dateListContainer.style.display = view === 'daily' ? 'block' : 'none';
            }
            historyTabs.querySelectorAll('button').forEach(btn => {
                const isActive = btn.dataset.view === view;
                btn.classList.toggle('font-semibold', isActive);
                btn.classList.toggle('text-blue-600', isActive);
                btn.classList.toggle('border-b-2', isActive);
                btn.classList.toggle('border-blue-600', isActive);
                btn.classList.toggle('text-gray-500', !isActive);
            });
            Array.from(historyViewContainer.children).forEach(child => child.classList.toggle('hidden', child.id !== `history-${view}-view`));
            
            if (view === 'daily') {
                const selectedDateBtn = historyDateList.querySelector('button.font-bold');
                if (selectedDateBtn) renderHistoryDetail(selectedDateBtn.dataset.key);
                else document.getElementById('history-daily-view').innerHTML = `<div class="text-center text-gray-500 p-8">왼쪽 목록에서 날짜를 선택하여 상세 정보를 확인하세요.</div>`;
            }
            if (view === 'weekly') renderWeeklyHistory();
            if (view === 'monthly') renderMonthlyHistory();
        };

        confirmHistoryDeleteBtn.addEventListener('click', async () => {
            if (historyKeyToDelete) {
                const docRef = doc(db, "artifacts", APP_ID, "history", historyKeyToDelete);
                await deleteDoc(docRef);
                showToast('선택한 날짜의 기록이 삭제되었습니다.');
                loadAndRenderHistoryList();
            }
            deleteHistoryModal.classList.add('hidden');
            historyKeyToDelete = null;
        });

        confirmQuantityBtn.addEventListener('click', () => {
            const inputs = document.querySelectorAll('#modal-task-quantity-inputs input');
            const newQuantities = {};
            inputs.forEach(input => {
                const task = input.dataset.task;
                const value = parseInt(input.value, 10);
                newQuantities[task] = (!isNaN(value) && value >= 0) ? value : 0;
            });

            if (quantityModalContext.onConfirm) {
                quantityModalContext.onConfirm(newQuantities);
            }
            quantityModal.classList.add('hidden');
        });

        confirmEditBtn.addEventListener('click', () => {
            if (recordToEditId === null) return;

            const record = appState.workRecords.find(r => r.id === recordToEditId);
            if (!record) return;

            const newStartTime = document.getElementById('edit-start-time').value;
            const newEndTime = document.getElementById('edit-end-time').value;
            const newtask = document.getElementById('edit-task-type').value;

            record.startTime = newStartTime;
            record.endTime = newEndTime;
            record.task = newtask;

            if (newStartTime && newEndTime) {
                const start = new Date(`1970-01-01T${newStartTime}`);
                const end = new Date(`1970-01-01T${newEndTime}`);
                const newDuration = (end - start) / (1000 * 60);
                record.duration = newDuration > 0 ? newDuration : 0;
            } else {
                record.duration = 0;
            }


            saveStateToFirestore();
            showToast('기록이 수정되었습니다.');
            editRecordModal.classList.add('hidden');
            recordToEditId = null;
        });
        
        confirmQuantityOnStopBtn.addEventListener('click', () => {
            const quantity = parseInt(document.getElementById('quantity-on-stop-input').value, 10) || 0;
            finalizeStopGroup(groupToStopId, quantity);
        });

        cancelQuantityOnStopBtn.addEventListener('click', () => {
            finalizeStopGroup(groupToStopId, null);
        });
        
        document.getElementById('open-task-modal-btn').addEventListener('click', () => {
            taskSelectModal.classList.remove('hidden');
        });

        taskSelectModal.addEventListener('click', e => {
            if (e.target.classList.contains('task-select-btn')) {
                selectedTaskForStart = e.target.dataset.task;
                document.getElementById('open-task-modal-btn').textContent = selectedTaskForStart;
                taskSelectModal.classList.add('hidden');
            }
            if (e.target.closest('.modal-close-btn')) {
                taskSelectModal.classList.add('hidden');
            }
        });

        confirmStopIndividualBtn.addEventListener('click', () => {
            if (recordToStopId !== null) {
                stopWorkIndividual(recordToStopId);
            }
            stopIndividualConfirmModal.classList.add('hidden');
            recordToStopId = null;
        });

        cancelStopIndividualBtn.addEventListener('click', () => {
            stopIndividualConfirmModal.classList.add('hidden');
            recordToStopId = null;
        });

        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.fixed').classList.add('hidden');
            });
        });

        cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
        cancelQuantityBtn.addEventListener('click', () => {
            if (quantityModalContext.onCancel) {
                quantityModalContext.onCancel();
            }
            quantityModal.classList.add('hidden');
        });
        cancelHistoryDeleteBtn.addEventListener('click', () => deleteHistoryModal.classList.add('hidden'));
        cancelEditBtn.addEventListener('click', () => editRecordModal.classList.add('hidden'));
        cancelResetAppBtn.addEventListener('click', () => resetAppModal.classList.add('hidden'));

        [toggleCompletedLog, toggleAnalysis, toggleSummary].forEach(toggle => {
            toggle.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    const content = toggle.nextElementSibling;
                    const arrow = toggle.querySelector('svg');
                    content.classList.toggle('hidden');
                    if (content.id === 'summary-content') content.classList.toggle('grid');
                    if(arrow) arrow.classList.toggle('rotate-180');
                }
            });
        });
        
        const populatePartTimerCount = () => {
            const selectEl = document.getElementById('part-timer-count');
            selectEl.innerHTML = '';
            for (let i = 0; i <= 10; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}명`;
                selectEl.appendChild(option);
            }
        };

        const displayCurrentDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
            const dayOfWeek = weekdays[now.getDay()];
            const dateString = `${year}년 ${month}월 ${day}일 (${dayOfWeek})`;
            document.getElementById('current-date-display').textContent = dateString;
        };
        
        // --- App Initialization ---
        function main() {
            renderTaskSelectionModal();
            populatePartTimerCount();
            displayCurrentDate();
            
            if (elapsedTimeTimer) clearInterval(elapsedTimeTimer);
            elapsedTimeTimer = setInterval(updateElapsedTimes, 1000);

            const defaultState = { workRecords: [], taskQuantities: {}, onLeaveMembers: [], selectedForTask: [], hiddenGroupIds: [] };
            taskTypes.forEach(task => defaultState.taskQuantities[task] = 0);
            appState = defaultState;
            render();

            connectionStatusEl.textContent = '연결 중...';
            statusDotEl.className = 'w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse';

            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                connectionStatusEl.textContent = "설정 필요";
                statusDotEl.className = 'w-2.5 h-2.5 rounded-full bg-red-500';
                showToast("프로그램 코드에 Firebase 구성 정보를 입력해주세요.", true);
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async user => {
                if (user) {
                    await fetchAppConfig();

                    const todayDocRef = doc(db, "artifacts", APP_ID, "daily_data", getTodayDateString());
                    if (unsubscribeToday) unsubscribeToday();
                    unsubscribeToday = onSnapshot(todayDocRef, (docSnap) => {
                        const defaultState = { workRecords: [], taskQuantities: {}, onLeaveMembers: [], selectedForTask: [], hiddenGroupIds: [] };
                        taskTypes.forEach(task => defaultState.taskQuantities[task] = 0);
                        
                        if (docSnap.exists()) {
                            try {
                                const remoteState = JSON.parse(docSnap.data().state);
                                const currentSelection = appState.selectedForTask;
                                appState = { ...defaultState, ...remoteState };
                                appState.selectedForTask = currentSelection;
                                if (!appState.workRecords) appState.workRecords = [];
                                if (!appState.taskQuantities) appState.taskQuantities = defaultState.taskQuantities;
                                if (!appState.onLeaveMembers) appState.onLeaveMembers = [];
                                if (!appState.hiddenGroupIds) appState.hiddenGroupIds = [];
                            } catch (e) {
                                console.error("Error parsing state from Firestore:", e);
                                appState = defaultState;
                            }
                        } else {
                            appState = defaultState;
                        }
                        render();
                        connectionStatusEl.textContent = '동기화';
                        statusDotEl.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
                    }, (error) => {
                        console.error("Firebase onSnapshot error:", error);
                        showToast("실시간 연결에 실패했습니다. 보안 규칙을 확인하세요.", true);
                        connectionStatusEl.textContent = '연결 오류';
                        statusDotEl.className = 'w-2.5 h-2.5 rounded-full bg-red-500';
                    });
                }
            });
            
            signInAnonymously(auth).catch(error => {
                console.error("Anonymous sign-in failed:", error);
                showToast("인증에 실패했습니다. Firebase 설정을 확인하세요.", true);
                connectionStatusEl.textContent = '인증 실패';
                statusDotEl.className = 'w-2.5 h-2.5 rounded-full bg-red-500';
            });
        }

        main();
    </script>
</body>
</html>

